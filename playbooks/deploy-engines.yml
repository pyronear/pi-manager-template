---
- name: Verify Ansible version and setup servers
  hosts: engine_servers
  become: true
  tasks:
    - name: Ensure Ansible version is 2.17 or higher
      ansible.builtin.assert:
        that:
          - ansible_version.minor | int >= 17
        fail_msg: "Ansible version must be 2.17 or higher : {{ ansible_version.minor }}"

  roles:
    - check_vars
    - engine_cron

- name: Verify Ansible version and setup servers
  hosts: engine_servers
  become: true
  tasks:
    - name: Install Alloy
      ansible.builtin.include_role:
        name: grafana.grafana.alloy

    - name: Create a cronjob to restart the Raspberry Pi every day at midnight
      ansible.builtin.cron:
        name: "Restart Raspberry Pi"
        minute: "0"
        hour: "0"
        job: "/sbin/shutdown -r now"
        user: "root"

- name: Deploy Docker Compose Engines
  hosts: engine_servers
  become: true
  roles:
    - engine
